<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>LCLPLauncher</title>
    
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.css">
    <link rel="stylesheet" href="node_modules/material-design-icons/iconfont/material-icons.css">
    
    <link rel="stylesheet" href="./css/parallax.css">

    <style>
        #stepProgress {
            transition: none;
        }
    </style>
    
    <script src="resources/jquery/jquery.min.js"></script>

    <script>
        const homedir = require('os').homedir(), defaultInstallationDir = homedir + "/lclpserver5";
        const path = require("path");
        const fs = require("fs");
        const installer = require("./js/install");
        const config = require("./js/config");
        const cp = require("child_process");
        const app = require("electron").remote.app;
        const server = app.tcpServerModule;

        config.init(config.KEY_INSTALLATION_DIR, defaultInstallationDir);

        $("document").ready(() => {
            checkInstallation();
            checkForUpdates();
        });

        function isValid(dir) {
            return !fs.existsSync(dir) || fs.readdirSync(dir).length <= 0;
        }

        function openInstallDialog() {
            let input = document.getElementById("installDirInput");
            input.value = config.getInstallationDir();
            input.classList.add(isValid(input.value) ? "is-valid" : "is-invalid");
            $('#installModal').modal("show");
        }

        function openInstallDirChooser() {
            const {dialog} = require('electron').remote;
            dialog.showOpenDialog({
                properties: ['openDirectory', 'showHiddenFiles']
            }).then(result => {
                if(result.canceled || result.filePaths === undefined || result.filePaths.length != 1) return;

                let input = document.getElementById("installDirInput");
                let dir = result.filePaths[0];
                if(input != null) {
                    input.classList.remove("is-valid");
                    input.classList.remove("is-invalid");
                    
                    if(!fs.existsSync(dir) || fs.readdirSync(dir).length == 0) {
                        input.value = dir;
                        input.classList.add("is-valid");
                    } else {
                        dir += "/lclpserver5";
                        input.value = dir;
                        input.classList.add(isValid(dir) ? "is-valid" : "is-invalid");
                    }
                }
            });
        }

        function update() {
            callInstaller(config.getInstallationDir());
        }

        function install() {
            $('#locateExistingInstallationModal').modal("hide");
            let input = document.getElementById("installDirInput");
            installDir = input.value;
            installDir = path.normalize(installDir);
            if(!path.isAbsolute(installDir)) {
                console.error("The target installation directory '" + installDir + "' is not an absolute path.");
                return;
            }

            config.setInstallationDir(installDir);

            $("#installModal").modal("hide");

            callInstaller(installDir);
        }

        function callInstaller(installDir) {
            let modal = $("#progressModal");
            modal.modal({
                keyboard: false,
                backdrop: "static"
            });
            modal.modal("show");

            let stepsTitle = $("#stepDisplay"), 
                stepsProgress = $("#stepsProgress"), 
                statusTitle = $("#stepTitle"), 
                stepProgress = $("#stepProgress");

            installer.startInstaller(installDir,
            socket => {
                let clientName = undefined;
                if("undefined" !== typeof(socket["clientName"])) clientName = socket.clientName;
                
                if(clientName === undefined) console.log("Client disconnected.");
                else {
                    console.log(`Client '${clientName}' disconnected.`);
                    if(clientName === "launcherLogicInstaller") {
                        server.setCallback(json => {});
                        onInstalled();
                    }
                }
            },
            json => {
                if("undefined" !== typeof(json["forgeInstaller"])) {
                    console.log(json.forgeInstaller);
                    return;
                }
                
                let stepsPerc = (100 * json.step / json.steps).toFixed(0);
                stepsProgress.css("width", stepsPerc + "%").attr("aria-valuenow", stepsPerc);

                let stepsLabel = `Schritt ${json.step} von ${json.steps}`;
                if(stepsTitle.text() !== stepsLabel) stepsTitle.html(stepsLabel.bold());

                if(statusTitle.text() !== json.status) statusTitle.text(json.status);

                let perc = (json.stepProgress * 100).toFixed(0);
                stepProgress.css('width', perc + '%').attr('aria-valuenow', perc);
            });
        }

        function onInstalled() {
            let modal = $("#progressModal");
            modal.modal({
                keyboard: true,
                backdrop: true
            });
            modal.modal("hide");

            checkInstallation();
        }

        function isValidInstallation(dir) {
            const fs = require("fs");
            let installationExists = fs.existsSync(dir + "/.installation");
            return !isValid(dir) && installationExists;
        }

        function checkInstallation(doUpdate) {
            let dir = config.getInstallationDir();
            let exists = fs.existsSync(dir + "/.installation");
            if(!exists) {
                $("#installButton").unbind("click").on("click", () => {
                    openInstallDialog();
                });
                return;
            }

            if(doUpdate) {
                $("#installationTitle").text("Update verfügbar");
                $("#installationDescription").html("Der LCLPServer 5.0 Client muss aktualisiert werden.<br>Bitte aktualisiere den Client so schnell wie möglich!");
                $("#installButton").html("<b>Update</b>").addClass("btn-primary").removeClass("btn-success").unbind("click").on("click", update);
            } else {
                $("#installationTitle").text("Bereit zum Spielen");
                $("#installationDescription").html("Der LCLPServer 5.0 Client wurde installiert.<br>Er steht nun zum Spielen bereit!");
                $("#installButton").html("<b>Spielen</b>").addClass("btn-success").removeClass("btn-primary").unbind("click").on("click", play);
            }
        }
        
        function checkForUpdates() {
            let dir = config.getInstallationDir();

            let result;

            installer.startUpdateChecker(dir,
            socket => {
                let clientName = undefined;
                if("undefined" !== typeof(socket["clientName"])) clientName = socket.clientName;
                
                if(clientName === undefined) console.log("Client disconnected.");
                else {
                    console.log(`Client '${clientName}' disconnected.`);
                    if(clientName === "launcherLogicUpdater") {
                        server.setCallback(json => {});
                        evalResult(result);
                    }
                }
            },
            json => {
                result = json.status;
            });
        }

        function evalResult(result) {
            if(result !== "Installation is outdated.") return;
            
            console.log("Ein Update ist verfügbar.");
            checkInstallation(true);
        }

        function openInstallFinderDialog() {
            let input = document.getElementById("installFindDirInput");
            input.value = config.getInstallationDir();
            input.classList.add(isValidInstallation(input.value) ? "is-valid" : "is-invalid");
            $('#locateExistingInstallationModal').modal("show");
        }

        function openInstallFinderDirChooser() {
            const {dialog} = require('electron').remote;
            dialog.showOpenDialog({
                properties: ['openDirectory', 'showHiddenFiles']
            }).then(result => {
                if(result.canceled || result.filePaths === undefined || result.filePaths.length != 1) return;

                let input = document.getElementById("installFindDirInput");
                let dir = result.filePaths[0];
                if(input != null) {
                    input.value = dir;

                    input.classList.remove("is-valid");
                    input.classList.remove("is-invalid");

                    input.classList.add(isValidInstallation(dir) ? "is-valid" : "is-invalid");
                }
            });
        }

        function applyInstallationPath() {
            $('#locateExistingInstallationModal').modal("hide");

            let input = document.getElementById("installFindDirInput");
            let dir = input.value;
            if(!isValidInstallation(dir)) {
                alert(`'${dir}' ist keine gültige Installation von LCLPServer 5.0 !"`);
                return;
            }

            config.setInstallationDir(input.value);
            alert("Installationspfad wurde zu '" + input.value + "' geändert.");

            checkInstallation();
        }

        function play() {
            let dir = config.getInstallationDir();
            if(!isValidInstallation(dir)) {
                location.reload();
                alert("Die Installation von LCLPServer 5.0 ist nicht mehr gültig. Probiere, eine neue zu installieren.");
                return;
            }

            let path = "C:\\Program Files (x86)\\Minecraft Launcher\\MinecraftLauncher.exe"; //TODO change for other os
            if(!fs.existsSync(path)) alert("Konnte den Minecraft Launcher nicht automatisch öffnen. Bitte öffne den Minecraft Launcher manuell um zu spielen.");
            else {
                let args = ["-jar", "./bin/launcherlogic/LauncherLogic.jar",
                "preparePlay",
                "ls5"]
                let preparePlay = cp.spawnSync("./bin/launcherlogic/runtime/bin/java.exe", args, {});
                console.log(preparePlay.stdout.toString());

                cp.spawn(path, [], {
                    detached: true
                });
            }
        }
    </script>
</head>

<body>
    <script>
        let navbar = require("./js/navbar");
        document.write(navbar.getNavbarHTMLSync("./ls5.html"));
    </script>
    
    <div class="parallax" style="background-image: url('resources/img/ls5/snap1.png')">
        <div class="container">
            <img src="./resources/img/ls5/lclpserver5.png" alt="LCLPServer 5.0" width="100.0%" class="fadein" style="margin-top: 25%;">
        </div>
    </div>
    
    <div class="bg-secondary text-light text-center px-5 py-5">
        <div class="container">
            <h3>LCLPServer kehrt zurück</h3>
            <p>Nach mehr als 2 Jahren bekommt LCLPServer 4.0 seinen Nachfolger. Dieses Mal mit etwas ganz besonderem: ein Server mit <b>Mods</b>!</p>
            <p>Um auf dem Server zu spielen muss ein eigener Spielclient mithilfe des LCLPLaunchers &copy; installiert werden.</p>
        </div>
    </div>
    
    <div class="parallax" style="background-image: url('resources/img/ls5/snap4.png'); padding-top: 10%;">
        <div class="container">
            <h1 class="text-light">Riesiger neuer Spawn</h1>
            <p class="text-light">Um ein richtiges MMO feeling zu erschaffen wurde ein riesiger Spawn gebaut, in welchem es viele Quests o.Ä. zu erledigen gibt.</p>
            <hr class="bg-light">
            <div id="diashow" class="carousel slide mx-auto dshadow" data-ride="carousel">
                <ol class="carousel-indicators">
                    <li data-target="#diashow" data-slide-to="0" class="active"></li>
                    <li data-target="#diashow" data-slide-to="1"></li>
                    <li data-target="#diashow" data-slide-to="2"></li>
                </ol>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="./resources/img/ls5/snap2.png" class="d-block w-100" alt="Screenshot 2">
                    </div>
                    <div class="carousel-item">
                        <img src="./resources/img/ls5/snap3.png" class="d-block w-100" alt="Screenshot 3">
                    </div>
                    <div class="carousel-item">
                        <img src="./resources/img/ls5/snap5.png" class="d-block w-100" alt="Screenshot 5">
                    </div>
                </div>
                <a class="carousel-control-prev" href="#diashow" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Letztes</span>
                </a>
                <a class="carousel-control-next" href="#diashow" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Nächstes</span>
                </a>
            </div>
        </div>
    </div>
    
    <div class="bg-secondary text-light text-center px-5 py-5">
        <div class="container">
            <h3>Voraussichtlicher release</h3>
            <p>Da dieser Server sehr umfangreich werden soll und die Entwickler viel zu tun haben, wird der Server vermutlich erst gegen Ende 2020, wenn nicht sogar Anfang 2021 veröffentlicht werden.</p>
        </div>
    </div>

    <div class="parallax" style="background-image: url('resources/img/ls5/snap7.png'); padding-top: 25%;">
        <div class="container rounded dshadow p-5" style="background: rgba(94, 94, 94, 0.5);">
            <h1 class="text-light" id="installationTitle">Noch nicht installiert</h1>
            <hr class="bg-light">
            <p class="text-light" id="installationDescription">Der LCLPServer 5.0 Client ist noch nicht auf diesem Computer installiert.<br>
            Wurde der Client woanders installiert? Dann klicke <a href="#" class="btn-success rounded p-1" onclick="event.preventDefault(); openInstallFinderDialog()"><code>hier</code></a>.</p>
            <button id="installButton" class="btn btn-primary" style="font-size: 20px;"><b>Installieren</b></button>
        </div>
    </div>

    <!-- locate existing installation modal -->
    <div class="modal fade" id="locateExistingInstallationModal" tabindex="-1" role="dialog" aria-labelledby="locateExistingInstallationModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="locateExistingInstallationModalTitle">Installation finden</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
                <p>
                    Bitte gebe hier den Pfad zum existierenden Installationsverzeichnis <code>(/lclpserver5)</code> an.
                    Wenn noch kein Ordner existiert, musst du ihn erst installieren.
                </p>
                <div class="input-group mb-2">
                    <input type="text" class="form-control" id="installFindDirInput" placeholder="Dateipfad..." onclick="openInstallFinderDirChooser()">
                    <div class="input-group-append">
                        <button class="btn btn-primary" onclick="openInstallFinderDirChooser()">Suchen</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
              <button type="button" class="btn btn-primary" onclick="applyInstallationPath()">Speichern</button>
            </div>
          </div>
        </div>
    </div>
    <!-- / -->
    
    <!-- install modal -->
    <div class="modal fade" id="installModal" tabindex="-1" role="dialog" aria-labelledby="installModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="installModalTitle">LCLPServer Client installieren</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Der Client wird hierhin installiert:</p>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" id="installDirInput" placeholder="Dateipfad..." aria-describedby="pathHelpBlock" onclick="openInstallDirChooser()">
                        <div class="input-group-append">
                            <button class="btn btn-primary" onclick="openInstallDirChooser()">Ändern</button>
                        </div>
                        <div class="invalid-feedback">
                            Dieser Ordner ist nicht leer! Bitte wähle einen leeren Ordner.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" onclick="install()">Installieren</button>
                </div>
            </div>
        </div>
    </div>
    <!-- / -->

    <!-- progress modal -->
    <div class="modal fade" id="progressModal" tabindex="-1" role="dialog" aria-labelledby="progressModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="progressModalTitle">Installieren</h5>
                </div>
                <div class="modal-body">
                    <p>Der LCLPServer 5.0 Client wird installiert...</p>
                    <small id="stepDisplay">Starte Installation...</small>
                    <div class="progress">
                        <div id="stepsProgress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small id="stepTitle">...</small>
                    <div class="progress">
                        <div id="stepProgress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal" disabled>Abbrechen</button>
                </div>
            </div>
        </div>
    </div>
    <!-- / -->

    <script src="resources/popper.js/popper_fixed.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.js"></script>
</body>

</html>